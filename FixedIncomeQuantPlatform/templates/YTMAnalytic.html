<!DOCTYPE html>
<html lang="en">

<!--<script src="/static/js/jquery-3.2.1.min.js" type="text/javascript"></script>-->
<script src="/static/js/jquery-3.2.1.min.js" type="text/javascript"></script>
<script src="/static/js/highstock.js" type="text/javascript"></script>
<script src="/static/js/exporting.js" type="text/javascript"></script>
<script src="/static/js/highcharts-zh_CN.js" type="text/javascript"></script>
<script src="/static/js/public.js" type="text/javascript"></script>


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Highstock Example</title>

    <link href="/static/css/flexible.css" rel="stylesheet">
    <link href="/static/css/public.css" rel="stylesheet">
    <script src="/static/js/flexible.js"></script>

</head>

<body>

     <div class="div_tab_container">
         <div class="tab-group" id="YTM" style="margin-top: 0.2rem; margin-left: 0.2rem">
             <section id="YTM_tab1" title="债券走势图1">
                 <div id="YTM_tab1_container" class="container_highstock"></div>
             </section>
         </div>
         <div class="tab-group" id="YTMAnaltic" style="margin-top: 0.2rem; margin-left: 1.2rem; ">
             <section id="YTMAnaltic_tab1" title="价差历史统计">
                 <!-- 债券选择框1 -->
                  <div  style="position:relative;">
                      <div id="bondName1" style="height: 0.5rem; float:left; margin-left: .4rem; margin-top: .29rem">
                          债券1--类型：
                      </div>
                      <select id = "bondNameSelect1" style="height: 0.5rem; float:left; margin-left: .1rem; margin-top: .2rem;">
                          <option value="00">--选择债券--</option>
                      </select>
                      <div id="durationText1" style="height: 0.5rem; float:left; margin-left: 1rem; margin-top: .29rem">
                          债券1--期限：
                      </div>
                      <select id = "durationSelect1" style="height: 0.5rem;  margin-left: .1rem; margin-top: .2rem;">
                          <option value="00">--选择期限--</option>
                      </select>
                  </div>

                 <!-- 债券选择框2 -->
                  <div  style="position:relative;">
                      <div id="bondName2" style="height: 0.5rem; float:left; margin-left: .4rem; margin-top: .29rem">
                          债券2--类型：
                      </div>
                      <select id = "bondNameSelect2" style="height: 0.5rem; float:left; margin-left: .1rem; margin-top: .2rem;">
                          <option value="00">--选择债券--</option>
                      </select>
                      <div id="durationText2" style="height: 0.5rem; float:left; margin-left: 1rem; margin-top: .29rem">
                          债券2--期限：
                      </div>
                      <select id = "durationSelect2" style="height: 0.5rem; margin-left: .1rem; margin-top: .2rem;">
                          <option value="00">--选择期限--</option>
                      </select>
                  </div>

                  <div style="position:relative;">
                      <!-- 最新价差数据展示 -->
                      <div style="position:relative; margin-top: 0.3rem; margin-left: .4rem">最新价差显示:</div>
                      <!-- 昨结价差数据展示 -->
                      <div style="position:relative; margin-top: 0.3rem; margin-left: .4rem">昨结价差显示:</div>
                      <!-- 平均值，中位数展示 -->
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 1rem; float:left;">平均值:</div>
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 5rem;">中位数:</div>
                      <!-- 偏离平均值，百分位数展示 -->
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 1rem; float:left;">偏离平均值:</div>
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 5rem;">百分位数:</div>
                      <!-- 标准差，最大值展示 -->
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 1rem; float:left;">标准差:</div>
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 5rem;">最大值:</div>
                      <!-- 偏离标准差，最小值展示 -->
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 1rem; float:left;">偏离标准差:</div>
                      <div style="position:relative; margin-top: 0.3rem; margin-left: 5rem;">最小值:</div>
                  </div>
             </section>
         </div>
         <div class="tab-group" id="YTMSpread" style="margin-top: 0.6rem; margin-left: 0.2rem">
             <section id="YTM_tab2" title="债券走势图2">
                 <div id="YTM_tab2_container" class="container_highstock">
                 </div>
             </section>
         </div>
     </div>
{#    <div class="combobox_container">#}
{#            <h2>Orange + Medium</h2>#}
{#         <select class="demo-3">#}
{#			  <option value="sx">初中数学</option>#}
{#			  <option value="yw">初中语文</option>#}
{#			  <option value="yy">初中英语</option>#}
{#			  <option value="wl">初中物理</option>#}
{#         </select>#}
{#     </div>#}

    <script type="text/javascript">

        $(function() {
            //进度条
            /*
                $('body').mLoading({
                    text:"申万宏源欢迎您，加载数据中",//加载文字，默认值：加载中...
                });
            */
            //初始化页面
            init();
            /*
            //对于每一个tab标签，初始化highstock
            var tabList = {"中债农发行债", "#YTM_tab2":"中债国债",
                "#YTM_tab3":"中债国开债", "YTM_tab4":"FR007", "#YTM_tab5":"SHIBOR 3M"};
            */
            var duration = "1Y", startTime = null, endTime = null;
            loadYTMData("中债农发行债",duration, startTime, endTime);

            //刷新页面，每隔10秒刷新一次数据
            //setInterval(refreshQuoteData,5000);
        });

        function init()
        {
            //加载标签栏
            $('.tab-group').tabify();

            //初始债券类型下拉框
            selectInit($("#bondNameSelect1"),'bondytmtype');
            //初始期限下拉框
            selectInit($("#durationSelect1"),'bondytmduration');

            //绑定债券类型下拉框选择事件
            $("#bondNameSelect1").change(function(){
                var duration = $("#durationSelect").children('option:selected').text();
                var bondType = $(this).children('option:selected').text();
                var startTime = null, endTime = null;
                loadYTMData(bondType,duration, startTime, endTime);
            });

            //绑定期限下拉框选择事件
            $("#durationSelect1").change(function(){
                var duration = $(this).children('option:selected').text();
                var bondType = $("#bondNameSelect").children('option:selected').text();
                var startTime = null, endTime = null;
                loadYTMData(bondType,duration, startTime, endTime);
            });
            /*  获取标签页名称的方法
            $( "#YTM_tab1" ).on("click", function() {
                var duration = '1Y'
                var bondName = $('.tab-group section.active').get(0).title;
                {#var id = $('.tab-group section.active').get(0).id#}
                {#alert(id)#}
                {#$("#YTM_tab1").attr('title','aaa')#}
                var startTime = null, endTime = null;
                loadYTMData(bondName, duration, startTime, endTime);
            });
            */
        }

        function loadYTMData(bondType, duration, startTime, endTime){
            var url = '/FixedIncome/YTMAnalytic/loadData';
            $.ajax({
                type: 'POST',
                data:{
                    "bondType":bondType,
                    "duration":duration,
                    "startTime":startTime,
                    "endTime":endTime
                },
                dataType: 'json',
                url: url,
                success: loadData,
                error: errorInfo,
                //采用异步
                async: true
            });
        }

        var loadData = function(data) {
            var seriesData = [];
            var arrayData = [];
            //解析json数据
            data = JSON.parse(data) ;
            //取出债券名称
            var bondType = data.bondType;
            //加载数据
            $.each(data.quoteData, function (i, item) {
                seriesData.push([
                    str2UTC(item.timestamp),
                    parseFloat(item.bondytm)
                ]);
                arrayData.push([
                    parseFloat(item.bondytm)
                ]);
            });
            /*******  创建图形  ******/
            createCharts(seriesData, bondType)
            //$('body').mLoading("hide");

            /*******  加载数据分析数据  ******/
            //销毁变量，释放空间
            delete seriesData
            loadAnalysisData(arrayData)
            //console.log(data);
        };

        function createCharts(data, bondType) {
            //关闭UTC时间,设置title格式
            Highcharts.setOptions({
                global:{useUTC: false},
                //去除左上角的字体
                lang: {
                    rangeSelectorZoom: null
                },
                title: { align: 'left', x: 5,
	                style: {
                        fontSize: '12px',
                        color: '#304354',
  	                    fontWeight: 'bold'
                    }
                }
            });
            // Create the chart
            Highcharts.stockChart('YTM_tab1_container', {
                title: {
                    //设置标题
                    text : bondType,
                },
                tooltip: {
                    xDateFormat: '%Y-%m-%d',
                    shared: true,
                },
                plotOptions: {
                    series: {
                        pointStart: Date.UTC(2012, 0, 1),
                        pointInterval: 24 * 3600 * 1000
                    }
                },
                xAxis: {
                    type: 'datetime',
                    labels: {
                        rotation: -45,
                        style: {
                            fontSize: '8px',
                            fontFamily: 'Verdana, sans-serif'
                        }
                    }
                },
                yAxis: {
                    title: {
                        text: '到期收益率'
                    }
                },
                series: [{
                    name: 'YTM',
                    data: data,
                    id: 'dataseries'
                // the event marker flags
                }, {
                    type: 'flags',
                    data: [{}],
                    onSeries: 'dataseries',
                    shape: 'circlepin',
                    width: 16
                }],
                rangeSelector: {
                    buttonTheme: {
                        display: 'none' // 不显示按钮
                    },
                    selected: 0,
                    inputEnabled: true // 不显示日期输入框
                },
                //添加切换久期的按钮
                exporting: {
                    buttons: {
                        contextButton: {
                            enabled:false,
                            menuItems: [{
                                text: 'Download PDF',
                                onclick: function () {
                                    this.exportChart({
                                        type: 'application/pdf'
                                    });
                                }
                            }, {
                                text: 'Print',
                                onclick: function () {
                                    alert('Launch Print Table function')
                                },
                                separator: false
                            }]
                        }
                    }
                }
            });
        }

        /***** 数据分析函数 *****/
        function loadAnalysisData(arrayData) {
            var url = '/FixedIncome/YTMAnalytic/getBondYTMAnalyicData';
            $.ajax({
                type: 'POST',
                data:{
                    "arrayData[]":arrayData
                },
                dataType: 'json',
                url: url,
                success: loadAnalysis,
                error: errorInfo,
                //采用异步
                async: true
            });
        }

         var loadAnalysis = function(data) {

         };


        //错误信息处理界面
        var errorInfo = function(msg){
            console.log(msg);
            //关闭进度条
            //$('body').mLoading("hide");
        };

        function str2UTC(str) {
            date = new Date(Date.parse(str.replace(/-/g, "/")))
            //组成UTC
            var y =  date.getUTCFullYear();
            var m = date.getUTCMonth() ;
            var d = date.getUTCDate();
            var h= date.getUTCHours();
            var M = date.getUTCMinutes();
            var s = date.getUTCSeconds();
            //这里只选年月日，如有需要可以多选
            var utc = Date.UTC(y,m,d);
            return utc
        }

        //obj为标签栏id(格式$("#se"))，codetype为sys_code中code类型的名称
        function selectInit(obj,codeType) {
             //初始下拉框
            var url = '/publicMethod/getSYSCode';
            $.ajax({
                type: 'POST',
                data:{
                    "codeType":codeType,
                },
                dataType: 'json',
                url: url,
                success: function (data) {
                    data = JSON.parse(data);
                    //根据data返回值初始化下拉框
                    for(var i=0;i<data.length;i++){
                        var opt=$("<option>");
                        opt.val(data[i].val);
                        opt.text(data[i].text);
                        obj.append(opt);
                    }
                },
                error: errorInfo,
                //采用异步
                async: false
            });
        }
    </script>


</body>
</html>